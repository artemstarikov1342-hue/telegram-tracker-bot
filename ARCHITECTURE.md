# 🏗️ Архитектура системы

Описание архитектуры интеграции Telegram ↔ Яндекс.Трекер

## Общая схема

```
┌─────────────────────────────────────────────────────────────────┐
│                        TELEGRAM                                  │
│                                                                  │
│  ┌──────────────┐      ┌──────────────┐      ┌──────────────┐  │
│  │ Чат партнера │      │ Чат партнера │      │ Чат партнера │  │
│  │   Альфа      │      │   Бета       │      │   Гамма      │  │
│  │ ID: -100123  │      │ ID: -100987  │      │ ID: -100555  │  │
│  └──────┬───────┘      └──────┬───────┘      └──────┬───────┘  │
│         │                     │                     │           │
│         └─────────────────────┴─────────────────────┘           │
│                               │                                 │
└───────────────────────────────┼─────────────────────────────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   TELEGRAM BOT        │
                    │   (bot.py)            │
                    │                       │
                    │  • Получает сообщения │
                    │  • Парсит #задача     │
                    │  • Распределяет       │
                    └───────────┬───────────┘
                                │
                    ┌───────────┴───────────┐
                    │                       │
                    ▼                       ▼
        ┌─────────────────────┐  ┌─────────────────────┐
        │   DATABASE          │  │   YANDEX.TRACKER    │
        │   (tasks_db.json)   │  │   API CLIENT        │
        │                     │  │   (yandex_tracker.py)│
        │  • Связь задач      │  │                     │
        │    и чатов          │  │  • Создание задач   │
        │  • История          │  │  • Обновление       │
        │  • Статусы          │  │  • Комментарии      │
        └─────────────────────┘  └──────────┬──────────┘
                                            │
                                            │
                    ┌───────────────────────┴───────────────────────┐
                    │                                               │
                    ▼                                               ▼
        ┌─────────────────────┐                         ┌─────────────────────┐
        │   ОЧЕРЕДИ ОТДЕЛОВ   │                         │  ОЧЕРЕДИ ПАРТНЕРОВ  │
        │                     │                         │                     │
        │  ┌──────────────┐   │                         │  ┌──────────────┐   │
        │  │   DEV        │   │                         │  │  PARTNER1    │   │
        │  │ Разработка   │   │                         │  │ Партн. Альфа │   │
        │  └──────────────┘   │                         │  └──────────────┘   │
        │                     │                         │                     │
        │  ┌──────────────┐   │                         │  ┌──────────────┐   │
        │  │   MGR        │   │                         │  │  PARTNER2    │   │
        │  │ Менеджеры    │   │                         │  │ Партн. Бета  │   │
        │  └──────────────┘   │                         │  └──────────────┘   │
        │                     │                         │                     │
        │  ┌──────────────┐   │                         │  ┌──────────────┐   │
        │  │   OPS        │   │                         │  │  PARTNER3    │   │
        │  │ Операционный │   │                         │  │ Партн. Гамма │   │
        │  └──────────────┘   │                         │  └──────────────┘   │
        └─────────────────────┘                         └─────────────────────┘
```

## Поток создания задачи

### 1. Пользователь отправляет сообщение

```
Менеджер в чате с партнером:
┌────────────────────────────────────┐
│ #задача #dev #ops Проблема с API   │
│ Эндпоинт /users не отвечает        │
└────────────────────────────────────┘
```

### 2. Бот получает и парсит сообщение

```python
# bot.py → handle_message()

1. Проверка наличия #задача
   ✓ Найдено

2. Извлечение текста после #задача
   → "Проблема с API\nЭндпоинт /users не отвечает"

3. Поиск хештегов отделов
   → Найдено: #dev, #ops

4. Определение chat_id
   → -1001234567890 (Партнер Альфа)
```

### 3. Создание задач

Бот создает **3 задачи**:

```
┌─────────────────────────────────────────┐
│ Задача 1: DEV-123                       │
│ Очередь: DEV (Разработка)              │
│ Название: "Проблема с API"             │
│ Приоритет: critical                     │
│ Дедлайн: 2026-02-03                    │
│ Исполнитель: (не назначен)             │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ Задача 2: OPS-456                       │
│ Очередь: OPS (Операционный)            │
│ Название: "Проблема с API"             │
│ Приоритет: critical                     │
│ Дедлайн: 2026-02-03                    │
│ Исполнитель: (не назначен)             │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ Задача 3: PARTNER1-789                  │
│ Очередь: PARTNER1 (Партнер Альфа)      │
│ Название: "Проблема с API"             │
│ Приоритет: critical                     │
│ Дедлайн: 2026-02-03                    │
│ Исполнитель: (не назначен)             │
└─────────────────────────────────────────┘
```

### 4. Сохранение в БД

```json
{
  "tasks": {
    "DEV-123": {
      "chat_id": -1001234567890,
      "message_id": 12345,
      "summary": "Проблема с API",
      "queue": "DEV",
      "department": "dev",
      "status": "open"
    },
    "OPS-456": { ... },
    "PARTNER1-789": { ... }
  },
  "chats": {
    "-1001234567890": ["DEV-123", "OPS-456", "PARTNER1-789"]
  }
}
```

### 5. Ответ пользователю

```
Бот → Менеджер:
┌────────────────────────────────────────────┐
│ ✅ Задача создана успешно!                 │
│                                            │
│ 📝 Название: Проблема с API                │
│ ⚠️ Приоритет: critical                     │
│ 📅 Дедлайн: 2026-02-03                    │
│                                            │
│ 1. 📋 DEV-123 (Разработка)                │
│    🔗 https://tracker.yandex.ru/DEV-123   │
│                                            │
│ 2. 📋 OPS-456 (Операционный)              │
│    🔗 https://tracker.yandex.ru/OPS-456   │
│                                            │
│ 3. 📋 PARTNER1-789 (Партнер)              │
│    🔗 https://tracker.yandex.ru/PARTNER1-789│
│                                            │
│ [✅ Завершить задачу]                      │
└────────────────────────────────────────────┘
```

## Структура модулей

### bot.py
**Основной модуль бота**

```python
class TrackerBot:
    __init__()                    # Инициализация
    parse_task_from_message()     # Парсинг #задача
    get_departments_from_message()# Извлечение #dev, #mgr, #ops
    get_partner_queue()           # Очередь партнера по chat_id
    handle_message()              # Обработка сообщений
    handle_complete_task()        # Завершение задачи
    start_command()               # Команда /start
    help_command()                # Команда /help
    info_command()                # Команда /info
    mytasks_command()             # Команда /mytasks
    run()                         # Запуск бота
```

### yandex_tracker.py
**API клиент для Яндекс.Трекера**

```python
class YandexTrackerClient:
    create_issue()                # Создание задачи
    get_issue()                   # Получение задачи
    update_issue_status()         # Изменение статуса
    add_comment()                 # Добавление комментария
    get_queue_info()              # Информация об очереди
    get_user_info()               # Информация о пользователе
```

### database.py
**База данных задач**

```python
class TaskDatabase:
    add_task()                    # Добавить задачу
    get_task()                    # Получить задачу
    update_task_status()          # Обновить статус
    get_chat_tasks()              # Задачи чата
    search_task_by_text()         # Поиск задачи
```

### config.py
**Конфигурация**

```python
# Настройки Telegram
TELEGRAM_BOT_TOKEN

# Настройки Яндекс.Трекера
YANDEX_TRACKER_TOKEN
YANDEX_ORG_ID

# Маппинг отделов
DEPARTMENT_MAPPING = {
    'dev': {...},
    'mgr': {...},
    'ops': {...}
}

# Маппинг партнеров
PARTNER_CHAT_MAPPING = {
    -1001234567890: {...},
    -1009876543210: {...}
}

# Параметры по умолчанию
DEFAULT_PRIORITY = 'critical'
DEFAULT_DEADLINE_DAYS = 0
```

## Обработка команд

```
/start → start_command()
         ├─ Приветствие
         └─ Краткая инструкция

/help → help_command()
        ├─ Список команд
        ├─ Доступные отделы
        └─ Примеры использования

/info → info_command()
        ├─ ID пользователя
        ├─ ID чата
        ├─ Партнер
        ├─ Настройки
        └─ Количество задач

/mytasks → mytasks_command()
           ├─ Список активных задач
           └─ Ссылки на Трекер

#задача → handle_message()
          ├─ Парсинг текста
          ├─ Определение отделов
          ├─ Создание задач
          ├─ Сохранение в БД
          └─ Ответ пользователю

[Кнопка] → handle_complete_task()
           ├─ Завершение в Трекере
           ├─ Обновление в БД
           └─ Обновление сообщения
```

## Маппинг чатов на партнеров

```
Telegram Chat ID → Partner Info → Yandex Queue
─────────────────────────────────────────────
-1001234567890   → Партнер Альфа → PARTNER1
-1009876543210   → Партнер Бета  → PARTNER2
-1005555444333   → Партнер Гамма → PARTNER3
```

## Маппинг хештегов на отделы

```
Хештег → Department Code → Queue → Assignee
──────────────────────────────────────────
#dev   → dev             → DEV   → (не назначен)
#mgr   → mgr             → MGR   → (не назначен)
#ops   → ops             → OPS   → (не назначен)
```

## Логика создания задач

```python
Если в сообщении есть #задача:
    1. Извлечь текст после #задача
    2. Найти все хештеги отделов (#dev, #mgr, #ops)
    3. Для каждого отдела:
        → Создать задачу в очереди отдела
        → Сохранить в БД
    4. Получить очередь партнера по chat_id
    5. Если очередь партнера настроена:
        → Создать задачу в очереди партнера
        → Сохранить в БД
    6. Если нет отделов и нет партнера:
        → Создать задачу в DEFAULT_QUEUE
    7. Отправить подтверждение со ссылками
```

## База данных (tasks_db.json)

```json
{
  "tasks": {
    "DEV-123": {
      "chat_id": -1001234567890,
      "message_id": 12345,
      "summary": "Проблема с API",
      "queue": "DEV",
      "department": "dev",
      "created_at": "2026-02-03T10:30:00",
      "status": "open"
    }
  },
  "chats": {
    "-1001234567890": [
      "DEV-123",
      "OPS-456",
      "PARTNER1-789"
    ]
  }
}
```

## Обработка ошибок

```
Ошибка создания задачи:
├─ Логирование в bot.log
├─ Сообщение пользователю
└─ Продолжение работы

Ошибка подключения к Трекеру:
├─ Повторная попытка
├─ Логирование
└─ Уведомление пользователя

Ошибка Telegram API:
├─ Автоматический retry
└─ Логирование
```

## Расширяемость

### Добавление нового партнера

1. Получить chat_id чата
2. Создать очередь в Трекере
3. Добавить в `PARTNER_CHAT_MAPPING`:
   ```python
   -1007777888899: {
       'partner_name': 'Новый партнер',
       'queue': 'PARTNER4',
   }
   ```

### Добавление нового отдела

1. Создать очередь в Трекере
2. Добавить в `DEPARTMENT_MAPPING`:
   ```python
   'sales': {
       'name': 'Продажи',
       'queue': 'SALES',
       'assignee': None,
       'hashtag': '#sales'
   }
   ```
3. Добавить синонимы в `DEPARTMENT_HASHTAGS`:
   ```python
   '#sales': 'sales',
   '#продажи': 'sales',
   ```

### Добавление webhook для уведомлений

```python
# В bot.py добавить:
async def webhook_handler():
    # Получать уведомления от Трекера
    # При изменении статуса → уведомлять в Telegram
```

## Безопасность

- ✅ OAuth токены в `.env` (не в репозитории)
- ✅ `.env` в `.gitignore`
- ✅ Проверка прав доступа в Трекере
- ✅ Логирование без чувствительных данных
- ✅ Валидация входных данных

## Производительность

- Асинхронная обработка сообщений
- Кэширование конфигурации
- Минимум API запросов
- Batch операции при возможности

---

**Архитектура спроектирована для:**
- ✅ Простоты использования
- ✅ Легкости настройки
- ✅ Масштабируемости
- ✅ Надежности
